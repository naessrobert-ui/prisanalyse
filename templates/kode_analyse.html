{% extends "base.html" %}

{% block title %}AI Kodeassistent{% endblock %}

{% block content %}
<style>
    /* --- CSS for denne spesifikke siden --- */

    /* Hovedboks med "Glass"-effekt opp√• bakgrunnsbildet */
    .analysis-container {
        background-color: rgba(255, 255, 255, 0.95); /* Hvit, litt gjennomsiktig */
        border-radius: 15px;
        padding: 40px;
        margin-top: 40px;
        margin-bottom: 40px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Moderne skygge */
        backdrop-filter: blur(4px); /* Gj√∏r bakgrunnen litt utydelig bak boksen */
        border: 1px solid rgba(255, 255, 255, 0.18);
        max-width: 900px;
        margin-left: auto;
        margin-right: auto;
    }

    /* Overskrift */
    .analysis-header {
        color: #333;
        margin-bottom: 20px;
        font-weight: 600;
    }

    /* Input-feltet */
    #promptInput {
        border-radius: 10px;
        border: 1px solid #ccc;
        padding: 15px;
        font-size: 1.1em;
        resize: vertical; /* Lar brukeren endre st√∏rrelse */
    }

    #promptInput:focus {
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        border-color: #007bff;
    }

    /* Knappen */
    .btn-generate {
        padding: 12px 30px;
        font-size: 1.1em;
        border-radius: 50px;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    /* Kodeboksen (Resultatet) */
    .code-wrapper {
        position: relative;
        display: none; /* Skjult til vi f√•r svar */
        margin-top: 30px;
    }

    #codeOutput {
        background-color: #1e1e1e; /* VS Code m√∏rk bakgrunn */
        color: #d4d4d4; /* Lys gr√• tekst */
        padding: 20px;
        border-radius: 10px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        white-space: pre-wrap; /* Beholder linjeskift og innrykk */
        border: 1px solid #333;
        min-height: 100px;
        text-align: left;
    }

    /* Kopier-knapp inne i kodeboksen */
    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        cursor: pointer;
    }
    .copy-btn:hover {
        background-color: rgba(255, 255, 255, 0.2);
    }

    /* Laste-animasjon */
    .loading-spinner {
        display: none;
        margin-top: 20px;
        color: #007bff;
    }
</style>

<div class="container">
    <div class="analysis-container">
        <div class="text-center">
            <h2 class="analysis-header">ü§ñ BQUANT Kodeassistent</h2>
            <p class="text-muted">
                Beskriv hva du vil analysere. Jeg genererer Python-kode tilpasset Bloomberg-milj√∏et.
            </p>
        </div>

        <div class="form-group mt-4">
            <textarea class="form-control" id="promptInput" rows="5" placeholder="Eksempel: Hent sluttkurs for EQNR og DNB de siste 2 √•rene og lag et plott som sammenligner avkastningen..."></textarea>
        </div>

        <div class="text-center mt-4">
            <button onclick="generateCode()" class="btn btn-primary btn-generate">
                ‚ú® Generer Kode
            </button>
        </div>

        <!-- Laste-indikator -->
        <div id="loadingIndicator" class="text-center loading-spinner">
            <div class="spinner-border" role="status" style="width: 3rem; height: 3rem;">
                <span class="sr-only">Loading...</span>
            </div>
            <p class="mt-2">Analyserer foresp√∏rselen og skriver kode...</p>
        </div>

        <!-- Resultat -->
        <div id="codeWrapper" class="code-wrapper">
            <button onclick="copyToClipboard()" class="copy-btn">Kopier kode</button>
            <div id="codeOutput"></div>
        </div>
    </div>
</div>

<!-- JavaScript logikk -->
<script>
    async function generateCode() {
        const prompt = document.getElementById('promptInput').value;
        const wrapper = document.getElementById('codeWrapper');
        const outputDiv = document.getElementById('codeOutput');
        const loadingDiv = document.getElementById('loadingIndicator');

        // Sjekk at feltet ikke er tomt
        if (!prompt.trim()) {
            alert("Vennligst skriv inn en beskrivelse f√∏rst.");
            return;
        }

        // Nullstill visning
        wrapper.style.display = 'none';
        outputDiv.innerText = '';
        loadingDiv.style.display = 'block';

        try {
            // Send data til Python-backend
            const response = await fetch('/kode/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ prompt: prompt }),
            });

            const data = await response.json();

            // Skjul laste-indikator
            loadingDiv.style.display = 'none';

            if (response.ok) {
                // Rens svaret litt (fjern ```python hvis det er der)
                let cleanCode = data.code.replace(/```python/g, "").replace(/```/g, "").trim();

                outputDiv.innerText = cleanCode;
                wrapper.style.display = 'block';
            } else {
                alert("Feil: " + (data.error || "Noe gikk galt p√• serveren."));
            }

        } catch (error) {
            loadingDiv.style.display = 'none';
            alert("Kunne ikke koble til serveren. Sjekk at appen kj√∏rer.\nFeilmelding: " + error);
        }
    }

    function copyToClipboard() {
        const codeText = document.getElementById('codeOutput').innerText;
        navigator.clipboard.writeText(codeText).then(() => {
            const btn = document.querySelector('.copy-btn');
            const originalText = btn.innerText;
            btn.innerText = "Kopiert! ‚úÖ";
            setTimeout(() => {
                btn.innerText = originalText;
            }, 2000);
        });
    }
</script>
{% endblock %}